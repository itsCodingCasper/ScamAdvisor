{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Hero Section -->
    <div class="hero-gradient text-white py-16">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-center mb-8">
                <span class="material-icons text-6xl mr-4">monitor</span>
                <div>
                    <h1 class="text-5xl font-bold mb-4">Social Media Monitor</h1>
                    <p class="text-xl opacity-90">AI-powered fraud detection across social platforms</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Monitor Form -->
            <div class="lg:col-span-2">
                <div class="google-card">
                    <div class="flex items-center mb-6">
                        <span class="material-icons text-blue-600 mr-3">search</span>
                        <h2 class="text-2xl font-semibold">Monitor Social Media Platforms</h2>
                    </div>

                    <form id="monitorForm" class="space-y-6">
                        <!-- Platform Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="material-icons text-sm align-middle mr-1">platform</span>
                                Select Platform
                            </label>
                            <select id="platform"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                required>
                                <option value="">Choose a platform...</option>
                                <option value="telegram">üîµ Telegram</option>
                                <option value="whatsapp">üü¢ WhatsApp</option>
                                <option value="youtube">üî¥ YouTube</option>
                                <option value="instagram">üì∑ Instagram</option>
                                <option value="facebook">üìò Facebook</option>
                                <option value="twitter">üê¶ Twitter/X</option>
                                <option value="linkedin">üíº LinkedIn</option>
                                <option value="tiktok">üéµ TikTok</option>
                            </select>
                        </div>

                        <!-- Search Terms -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="material-icons text-sm align-middle mr-1">search</span>
                                Search Terms & Keywords
                            </label>
                            <textarea id="searchTerms" rows="4"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter keywords to monitor for fraud indicators:&#10;Examples:&#10;‚Ä¢ Stock tips, guaranteed returns&#10;‚Ä¢ Crypto investment, doubling money&#10;‚Ä¢ Trading signals, insider information&#10;‚Ä¢ Investment group, join now"
                                required></textarea>
                            <p class="text-sm text-gray-500 mt-2">
                                <span class="material-icons text-sm align-middle mr-1">info</span>
                                Separate multiple terms with commas for comprehensive monitoring
                            </p>
                        </div>

                        <!-- Monitor Button -->
                        <button type="submit" class="google-button w-full py-3 text-lg font-medium">
                            <span class="material-icons align-middle mr-2">monitor_heart</span>
                            Start Monitoring
                        </button>
                    </form>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="google-card mt-8" style="display: none;">
                    <div class="flex items-center mb-6">
                        <span class="material-icons text-red-600 mr-3">report</span>
                        <h3 class="text-2xl font-semibold">Monitoring Results</h3>
                    </div>
                    <div id="monitorResults"></div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="space-y-6">
                <!-- Quick Stats -->
                <div class="google-card">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-green-600 mr-2">analytics</span>
                        <h3 class="text-lg font-semibold">Live Stats</h3>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Social Media Alerts</span>
                            <span id="socialMediaAlerts" class="font-bold text-red-600">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Platforms Monitored</span>
                            <span class="font-bold text-blue-600">8</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Active Threats</span>
                            <span class="font-bold text-yellow-600">Medium</span>
                        </div>
                    </div>
                </div>

                <!-- Common Fraud Indicators -->
                <div class="google-card">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-red-600 mr-2">warning</span>
                        <h3 class="text-lg font-semibold">Common Fraud Indicators</h3>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start">
                            <span class="material-icons text-red-500 text-sm mr-2 mt-0.5">error</span>
                            <span>Guaranteed returns or "risk-free" investments</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-orange-500 text-sm mr-2 mt-0.5">schedule</span>
                            <span>Urgent action required or limited time offers</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-yellow-600 text-sm mr-2 mt-0.5">lock</span>
                            <span>Secret trading strategies or insider tips</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-blue-500 text-sm mr-2 mt-0.5">group</span>
                            <span>Exclusive investment groups or communities</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-purple-500 text-sm mr-2 mt-0.5">verified</span>
                            <span>Fake expert credentials or testimonials</span>
                        </div>
                    </div>
                </div>

                <!-- Platform Safety Tips -->
                <div class="google-card">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-green-600 mr-2">security</span>
                        <h3 class="text-lg font-semibold">Safety Tips</h3>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start">
                            <span class="material-icons text-green-500 text-sm mr-2 mt-0.5">verified_user</span>
                            <span>Always verify advisor credentials through SEBI</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-blue-500 text-sm mr-2 mt-0.5">report</span>
                            <span>Report suspicious accounts to platform administrators</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-orange-500 text-sm mr-2 mt-0.5">cancel</span>
                            <span>Never share personal financial information</span>
                        </div>
                        <div class="flex items-start">
                            <span class="material-icons text-purple-500 text-sm mr-2 mt-0.5">school</span>
                            <span>Join official investor education groups only</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-sm mx-4">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold mb-2">Monitoring Social Media</h3>
            <p class="text-gray-600">Analyzing content for fraud indicators...</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const monitorForm = document.getElementById('monitorForm');
        const resultsSection = document.getElementById('resultsSection');
        const monitorResults = document.getElementById('monitorResults');
        const loadingModal = document.getElementById('loadingModal');

        // Load system stats
        loadSystemStats();

        monitorForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const platform = document.getElementById('platform').value;
            const searchTerms = document.getElementById('searchTerms').value;

            if (!platform || !searchTerms.trim()) {
                alert('Please select a platform and enter search terms');
                return;
            }

            // Show loading modal
            loadingModal.classList.remove('hidden');
            loadingModal.classList.add('flex');

            try {
                const response = await fetch('/api/monitor-social-media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        platform: platform,
                        search_terms: searchTerms
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.detail || 'Monitoring failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error during monitoring: ' + error.message);
            } finally {
                // Hide loading modal
                loadingModal.classList.add('hidden');
                loadingModal.classList.remove('flex');
            }
        });

        function displayResults(data) {
            const threatLevel = data.threat_level || 'Unknown';
            const threatColors = {
                'Critical': 'text-red-600 bg-red-50 border-red-200',
                'High': 'text-red-500 bg-red-50 border-red-200',
                'Medium': 'text-yellow-600 bg-yellow-50 border-yellow-200',
                'Low': 'text-green-600 bg-green-50 border-green-200'
            };

            const colorClass = threatColors[threatLevel] || 'text-gray-600 bg-gray-50 border-gray-200';

            monitorResults.innerHTML = `
            <div class="space-y-6">
                <!-- Threat Level Badge -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="material-icons text-2xl mr-3">security</span>
                        <div>
                            <h4 class="text-lg font-semibold">Threat Assessment</h4>
                            <p class="text-gray-600">Platform: ${data.platform || 'Unknown'}</p>
                        </div>
                    </div>
                    <div class="px-4 py-2 rounded-full border-2 ${colorClass}">
                        <span class="font-bold">${threatLevel} Risk</span>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                ${data.detailed_analysis ? `
                <div class="bg-gray-50 rounded-lg p-4">
                    <h5 class="font-semibold mb-3 flex items-center">
                        <span class="material-icons mr-2">analytics</span>
                        Detailed Analysis
                    </h5>
                    <div class="whitespace-pre-line text-sm">${data.detailed_analysis}</div>
                </div>
                ` : ''}

                <!-- Detected Patterns -->
                ${data.detected_patterns && Object.keys(data.detected_patterns).length > 0 ? `
                <div>
                    <h5 class="font-semibold mb-3 flex items-center">
                        <span class="material-icons mr-2 text-red-600">report_problem</span>
                        Detected Fraud Patterns
                    </h5>
                    <div class="grid gap-3">
                        ${Object.entries(data.detected_patterns).map(([category, patterns]) => `
                            <div class="border border-red-200 bg-red-50 rounded-lg p-3">
                                <h6 class="font-medium text-red-800 capitalize mb-2">${category.replace(/_/g, ' ')}</h6>
                                <div class="flex flex-wrap gap-2">
                                    ${patterns.map(pattern => `
                                        <span class="inline-block bg-red-100 text-red-700 px-2 py-1 rounded text-sm">
                                            ${pattern}
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Recommendations -->
                ${data.recommendations && data.recommendations.length > 0 ? `
                <div>
                    <h5 class="font-semibold mb-3 flex items-center">
                        <span class="material-icons mr-2 text-blue-600">lightbulb</span>
                        Recommendations
                    </h5>
                    <div class="space-y-2">
                        ${data.recommendations.map(recommendation => `
                            <div class="flex items-start bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <span class="material-icons text-blue-600 mr-2 mt-0.5 text-sm">check_circle</span>
                                <span class="text-sm">${recommendation}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Timestamp -->
                <div class="text-xs text-gray-500 border-t pt-3">
                    <span class="material-icons text-xs align-middle mr-1">schedule</span>
                    Analysis completed: ${new Date(data.timestamp).toLocaleString()}
                </div>
            </div>
        `;
        }

        async function loadSystemStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                if (response.ok) {
                    document.getElementById('socialMediaAlerts').textContent = stats.social_media_alerts || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Auto-refresh stats every 30 seconds
        setInterval(loadSystemStats, 30000);
    });
</script>
{% endblock %}